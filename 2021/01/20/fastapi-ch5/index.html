<!DOCTYPE html>
<html class="has-navbar-fixed-top">
<head>
    <meta charset="utf-8">
<title>【快速上車 FastAPI，感受開發快感】 - 資料庫連線及操作 - Theoo&#39;s Diary</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css">




<meta name="description" content="">





    <meta name="description" content="從上一個章節【定義 Response 和 Exception】已經大致了解，FastAPI 如何定義 Response 及 Exception 接下來這一章節的目的，則會介紹如何在 FastAPI 進行 database connection 和 database operation Outline FastAPI and SQLAlchemy 檔案結構 Initial create SQLAlc">
<meta property="og:type" content="article">
<meta property="og:title" content="【快速上車 FastAPI，感受開發快感】 - 資料庫連線及操作">
<meta property="og:url" content="https://theoohoho.github.io/2021/01/20/fastapi-ch5/index.html">
<meta property="og:site_name" content="Theoo&#39;s Diary">
<meta property="og:description" content="從上一個章節【定義 Response 和 Exception】已經大致了解，FastAPI 如何定義 Response 及 Exception 接下來這一章節的目的，則會介紹如何在 FastAPI 進行 database connection 和 database operation Outline FastAPI and SQLAlchemy 檔案結構 Initial create SQLAlc">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2021-01-20T12:18:20.000Z">
<meta property="article:modified_time" content="2021-01-20T12:18:20.000Z">
<meta property="article:author" content="theoohoho">
<meta property="article:tag" content="FastAPI, Python, Framework">
<meta name="twitter:card" content="summary">





<link rel="icon" href="/favicon.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/css/justifiedGallery.min.css">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-dark.min.css">


<link rel="stylesheet" href="/css/style.css">


<script defer src="//use.fontawesome.com/releases/v5.0.8/js/all.js"></script>


    
    
    
    
    
    
    
    
    
    

    


<meta name="generator" content="Hexo 5.4.0"></head>
<body>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/">
                
                    
                    Theoo&#39;s Diary
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/archives">Archives</a>
            
            <a class="navbar-item "
               href="/categories">Categories</a>
            
            <a class="navbar-item "
               href="/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            <a class="navbar-item search" title="Search" href="javascript:;">
                <i class="fas fa-search"></i>
            </a>
            
            
            
            <a class="navbar-item" title="GitHub" target="_blank" rel="noopener" href="https://github.com/theoohoho">
                
                <i class="fab fa-github"></i>
                
            </a>
               
            
        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            【快速上車 FastAPI，感受開發快感】 - 資料庫連線及操作
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            
                <time datetime="2021-01-20T12:18:20.000Z" itemprop="datePublished">Jan 20 2021</time>
            
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/categories/Python/">Python</a>
        </span>
        
        
        <span class="column is-narrow">
            
            
            28 minutes read (About 4149 words)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <html><head></head><body><p>從上一個章節【<strong>定義 Response 和 Exception</strong>】已經大致了解，FastAPI 如何定義 Response 及 Exception</p>
<p>接下來這一章節的目的，則會介紹如何在 FastAPI 進行 database connection 和 database operation</p>
<h2 id="Outline"><a href="#Outline" class="headerlink" title="Outline"></a>Outline</h2><ul>
<li>FastAPI and SQLAlchemy</li>
<li>檔案結構</li>
<li>Initial create SQLAlchemy</li>
<li>建立 SQLAlchemy ORM model</li>
<li>建立 Pydantic model<ul>
<li>如何進行 Pydantic model 和 ORM model 資料搬移?</li>
<li>Pydantic model Config</li>
</ul>
</li>
<li>建立資料庫 CRUD 方法<ul>
<li>實際使用 database operation</li>
<li>在 path operation 使用 database operation</li>
</ul>
</li>
<li>Reference</li>
<li>進階用法</li>
</ul>
<h2 id="FastAPI-and-SQLAlchemy"><a href="#FastAPI-and-SQLAlchemy" class="headerlink" title="FastAPI and SQLAlchemy"></a>FastAPI and SQLAlchemy</h2><p>FastAPI 主要使用 SQLAlchemy ORM 來進行 database connection 及操作，所以基本上 database 這部分的處理都是以 SQLAlchemy 標準操作為主</p>
<blockquote>
<p>SQLAlchemy ORM 可以支援許多 RDBMS e.g PostgreSQL、MySQL、SQLite、Oracle、MS SQL Server<br>可以參考 <a target="_blank" rel="noopener" href="https://www.sqlalchemy.org/">SQLAlchemy</a></p>
</blockquote>
<blockquote>
<p>甚麼是 ORM?<br>ORM 全名叫做 Object relational mapping，可以將程式語言建立的 object 和 database table 進行 mapping<br>白話一點就是將物件資料轉化成 database table，所以一個物件資料如果視為 database table的話</p>
</blockquote>
<p>比如說:</p>
<blockquote>
<p>物件本身代表一個 table<br>物件內的 attribute 代表 table field/column 有包含名稱及資料型別<br>物件內的 attribute value 代表 table row</p>
</blockquote>
<p>以 class 來解釋的話</p>
<blockquote>
<p>一個 class 為一個 table e.g <code>class Car</code><br>class 內定義的 attribute 為 table 的 field/column e.g <code>Car.name</code><br>以 class 實現的 instance 為 table row e.g <code>car_A = Car()</code></p>
<p>所以當指定 class.attribute時，ORM 會幫開發者進行 relation mapping 找到對應的 Table 及 column 來取得數值<br>又或是 class.attribute = value，進行修正 row 資料的操作，ORM 也可以幫我們找到對應的 ROW 進行調整</p>
</blockquote>
<blockquote>
<p>以上內容軍參考自 <a target="_blank" rel="noopener" href="https://fastapi.tiangolo.com/tutorial/sql-databases/">FastAPI - SQL (Relational) Databases</a></p>
</blockquote>
<h2 id="檔案結構"><a href="#檔案結構" class="headerlink" title="檔案結構"></a>檔案結構</h2><p>根據 FastAPI 對於 Database 操作的檔案結構建議分成:</p>
<ul>
<li><code>database.py</code>: 主要定義 database session，處理 database setup 和 connetion</li>
<li><code>models.py</code>: 主要定義定義可以 mapping to database table 的 ORM model，codebase 這邊會以 model 作為 database table，並對 model 進行 table 操作</li>
<li><code>schemas.py</code>: 主要定義 Pydantic model，可以針對 ORM model 的資料進行資料驗證/轉化，或者過濾資料</li>
<li><code>crud.py</code>: 主要定義 ORM model 的資料庫操作行為</li>
<li><code>main.py</code>: 主要程式進入點，定義之前章節所建立的 API</li>
</ul>
<h2 id="Initial-create-SQLAlchemy"><a href="#Initial-create-SQLAlchemy" class="headerlink" title="Initial create SQLAlchemy"></a>Initial create SQLAlchemy</h2><p><a target="_blank" rel="noopener" href="https://fastapi.tiangolo.com/tutorial/sql-databases/#create-the-sqlalchemy-parts">Reference</a></p>
<blockquote>
<p>Database Session 是什麼?<br>In the most general sense, the Session establishes all conversations with the database and represents a “holding zone” for all the objects which you’ve loaded or associated with it during its lifespan.</p>
<p>Session 是建立與 database 的所有連線，並且在 session 生命週期中，database session 會作為所有已載入 object或是關聯 object 的一個 holding zone<br>(白話一點就是，session是一個等待區，可以把已載入物件和關聯物件丟進來)<br>想要了解更多關於 SQLAlchemy 針對 Session 的介紹，以及處理可以參考 <a target="_blank" rel="noopener" href="https://docs.sqlalchemy.org/en/13/orm/session_basics.html#session-basics">Reference</a></p>
</blockquote>
<p>SQLAlchemy 初始建立 database session流程:</p>
<ol>
<li>Edit <code>database.py</code></li>
<li>Import sqlalchemy packages</li>
<li>Setup DB URL</li>
<li>Create an Engine，可以讓 database session 連接資源</li>
<li>Create a Session as Database Session to interact with DB</li>
<li>Create Base for later create DB model or ORM model</li>
<li>Create a get_db_session function to get database session instance</li>
</ol>
<ul>
<li>SQLite<figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> create_engine</span><br><span class="line"><span class="hljs-keyword">from</span> sqlalchemy.ext.declarative <span class="hljs-keyword">import</span> declarative_base</span><br><span class="line"><span class="hljs-keyword">from</span> sqlalchemy.orm <span class="hljs-keyword">import</span> sessionmaker</span><br><span class="line"></span><br><span class="line">DB_URL = <span class="hljs-string">"sqlite:///./sql_app.db"</span></span><br><span class="line"><span class="hljs-comment"># 只有 sqlite 需要加上 check_same_thread 的 attribute</span></span><br><span class="line"><span class="hljs-comment"># 因為 SQLite 每次只可以接收一個 thread 來處理一個 request</span></span><br><span class="line">Engine = create_engine(SQLALCHEMY_DATABASE_URL, connect_args={<span class="hljs-string">"check_same_thread"</span>: <span class="hljs-literal">False</span>})</span><br><span class="line"><span class="hljs-comment"># 由於 session</span></span><br><span class="line">SessionLocal = sessionmaker(autocommit=<span class="hljs-literal">False</span>, autoflush=<span class="hljs-literal">False</span>, bind=Engine)</span><br><span class="line"><span class="hljs-comment"># 建立 Base，作為後續建立 ORM model 時需要繼承的對象</span></span><br><span class="line">Base = declarative_base()</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># 建立 get_db_session() 並實現一個 database session instance and yield it</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_db_session</span>():</span></span><br><span class="line">    db = SessionLocal()</span><br><span class="line">    <span class="hljs-keyword">try</span>:</span><br><span class="line">        <span class="hljs-keyword">yield</span> db</span><br><span class="line">    <span class="hljs-keyword">except</span> Exception:</span><br><span class="line">        db.rollback()</span><br><span class="line">        <span class="hljs-keyword">raise</span></span><br><span class="line">    <span class="hljs-keyword">finally</span>:</span><br><span class="line">        db.close()</span><br></pre></td></tr></tbody></table></figure></li>
</ul>
<p>特別解釋一下 <code>get_db_session()</code>，這邊使用了 Generator 的語法</p>
<ol>
<li>第一次呼叫 <code>get_db_session()</code> 會先回傳 generator</li>
<li>第二次使用，會透過 <code>yield</code> 回傳建立好的 session instance</li>
<li>當 session 拋出去的過程中，遇到錯誤，則會執行 <code>rollback()</code></li>
<li>最後不管 session 成功執行或遇到錯誤，都會 <code>close()</code> 關閉 session 連線</li>
</ol>
<blockquote>
<p>關於 Genertator 語法的介紹，這邊就不再多描述，可以參考<a href=""></a></p>
</blockquote>
<ul>
<li>another database configuration - PostgreSQL<figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> create_engine</span><br><span class="line"><span class="hljs-keyword">from</span> sqlalchemy.ext.declarative <span class="hljs-keyword">import</span> declarative_base</span><br><span class="line"><span class="hljs-keyword">from</span> sqlalchemy.orm <span class="hljs-keyword">import</span> sessionmaker</span><br><span class="line"></span><br><span class="line">DB_URL = <span class="hljs-string">"postgresql:username:password@db_server/db_name"</span></span><br><span class="line">Engine = create_engine(SQLALCHEMY_DATABASE_URL)</span><br><span class="line">SessionLocal = sessionmaker(autocommit=<span class="hljs-literal">False</span>, autoflush=<span class="hljs-literal">False</span>, bind=Engine)</span><br><span class="line">Base = declarative_base()</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_db_session</span>():</span></span><br><span class="line">    db = SessionLocal()</span><br><span class="line">    <span class="hljs-keyword">try</span>:</span><br><span class="line">        <span class="hljs-keyword">yield</span> db</span><br><span class="line">    <span class="hljs-keyword">except</span> Exception:</span><br><span class="line">        db.rollback()</span><br><span class="line">        <span class="hljs-keyword">raise</span></span><br><span class="line">    <span class="hljs-keyword">finally</span>:</span><br><span class="line">        db.close()</span><br></pre></td></tr></tbody></table></figure>
<h2 id="建立-SQLAlchemy-ORM-model"><a href="#建立-SQLAlchemy-ORM-model" class="headerlink" title="建立 SQLAlchemy ORM model"></a>建立 SQLAlchemy ORM model</h2></li>
</ul>
<ol>
<li>Edit <code>models.py</code></li>
<li>create class inherit Base from initial create SQLAlchemy</li>
<li>create model correspond table name</li>
<li>create attritube/columns</li>
<li>create relationship</li>
</ol>
<blockquote>
<p>怕誤解 Pydantic model 和 ORM model<br>這兩個 model雖然都是用來描述資料模型，但彼此使用目的不同<br>Pydantic model 目的在於定義資料格式，實現資料輸入驗證、轉化輸出資料型別<br>ORM model 則是定義 database 資料模型，建立 Database connection，並且實現資料庫操作</p>
</blockquote>
<figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> Boolean, Column, ForeignKey, Integer, String</span><br><span class="line"><span class="hljs-keyword">from</span> .database <span class="hljs-keyword">import</span> Base</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span>(<span class="hljs-params">Base</span>):</span></span><br><span class="line">    <span class="hljs-comment"># create __tablename__ attribute，宣告 model 對應的 database table name</span></span><br><span class="line">    __tablename__ = <span class="hljs-string">"users"</span></span><br><span class="line">    <span class="hljs-comment"># create class attribute，宣告 model 對應的 table field/column</span></span><br><span class="line">    <span class="hljs-built_in">id</span> = Column(Integer, primary_key=<span class="hljs-literal">True</span>, index=<span class="hljs-literal">True</span>) </span><br><span class="line">    name = Column(String, index=<span class="hljs-literal">True</span>) </span><br><span class="line">    email = Column(String, unique=<span class="hljs-literal">True</span>)</span><br><span class="line">    active = Column(Boolean, default=<span class="hljs-literal">True</span>)</span><br><span class="line">    <span class="hljs-comment"># create relationship 建立 Table 關聯</span></span><br><span class="line">    books = relationship(<span class="hljs-string">"Books"</span>, back_populates=<span class="hljs-string">"owner"</span>)    </span><br><span class="line">    </span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Books</span>(<span class="hljs-params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="hljs-string">"books"</span></span><br><span class="line">    </span><br><span class="line">    <span class="hljs-built_in">id</span> = Column(Integer, primary_key=<span class="hljs-literal">True</span>, index=<span class="hljs-literal">True</span>)</span><br><span class="line">    title = Column(String, index=<span class="hljs-literal">True</span>)</span><br><span class="line">    description = Column(String)</span><br><span class="line">    price = Column(Integer)</span><br><span class="line">    owner_id = Column(Integer, ForeignKey(<span class="hljs-string">"users.id"</span>))</span><br><span class="line">    <span class="hljs-comment"># create relationship</span></span><br><span class="line">    owner = relationship(<span class="hljs-string">"User"</span>, back_populates=<span class="hljs-string">"books"</span>)</span><br></pre></td></tr></tbody></table></figure>

<p>解釋一下兩個 ORM model <code>Users</code> (users table)和 <code>Books</code>(books table)如何建立關聯<br>當兩張 table 建立好關聯之後，假設 database 目前資料狀態是一個 user 有多本書<br>我們從 database 讀取 user之後抽取一個 <code>Users</code> model (這邊以 <code>my_user</code>表示)，並指定 <code>my_user.books</code><br>database 會透過 Foreign key 找到和 <code>Books</code> model 相關聯的資料 row<br>並回傳和該 user 關聯的所有書本資料 <code>Books</code> model</p>
<p>而如果從 database 抽取一個 <code>Books</code> model(以 <code>my_book</code> 表示)，並指定 <code>my_book.owner</code><br>便可以取得</p>
<blockquote>
<p>更多 SQLAlchemy 定義 ORM model的細節，可以參考<a target="_blank" rel="noopener" href="https://docs.sqlalchemy.org/en/13/orm/tutorial.html">SQLAlchemy official doc</a></p>
</blockquote>
<h2 id="建立-Pydantic-model"><a href="#建立-Pydantic-model" class="headerlink" title="建立 Pydantic model"></a>建立 Pydantic model</h2><p>Pydnatic model 目的是可以針對 Table 資料，進行資料驗證或轉換</p>
<p>通常大部分應用層面的操作，資料都會盡量以 pydantic model 封裝起來，維持嚴謹資料格式<br>直到要將資料從 database 讀取或是寫入進 database時，才需要使用 ORM model</p>
<p>所以在定義銜接 orm model 的 pydantic model時，可以先思考哪些情境下會使用到 Pydantic model，以及在該情境下進行資料操作時，有哪些設定可以在 pydantic model 那邊實作，比如</p>
<ol>
<li>新增一個 database table row，希望由系統自動產生 table id 或是時間欄位，所以把產生 id or 產生時間資料的程式碼固定在 pydantic model，讓我每次建立新的 pydantic model 時都可以自動幫我產生資料</li>
<li></li>
</ol>
<p>而 Pydantic model 針對 orm model 定義資料格式有幾種選擇:</p>
<ol>
<li>可以根據 orm model 照實定義 pydantic model</li>
<li>也可以將自己認為不必要的資料過濾掉，比如說</li>
</ol>
<p>以下程式碼需要寫在 <code>schemas.py</code></p>
<figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field</span><br><span class="line"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> List</span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Books</span>(<span class="hljs-params">BaseModel</span>):</span></span><br><span class="line">    <span class="hljs-built_in">id</span>: <span class="hljs-built_in">int</span> = Field(...)</span><br><span class="line">    title: <span class="hljs-built_in">str</span> = Field(...)</span><br><span class="line">    description: <span class="hljs-built_in">str</span> = Field(...)</span><br><span class="line">    price: <span class="hljs-built_in">int</span> = Field(...)</span><br><span class="line">    owner_id: <span class="hljs-built_in">int</span> = Field(...)</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span>(<span class="hljs-params">BaseModel</span>):</span></span><br><span class="line">    <span class="hljs-built_in">id</span>: <span class="hljs-built_in">int</span> = Field(...)</span><br><span class="line">    name: <span class="hljs-built_in">str</span> = Field(...)</span><br><span class="line">    email: <span class="hljs-built_in">str</span> = Field(...)</span><br><span class="line">    active: <span class="hljs-built_in">bool</span> = Field(...)</span><br><span class="line">    books: List[Books]</span><br></pre></td></tr></tbody></table></figure>

<h3 id="如何進行-Pydantic-model-和-ORM-model-資料搬移"><a href="#如何進行-Pydantic-model-和-ORM-model-資料搬移" class="headerlink" title="如何進行 Pydantic model 和 ORM model 資料搬移?"></a>如何進行 Pydantic model 和 ORM model 資料搬移?</h3><p>現在已經知道 Pydantic model 和 ORM model 的目的，以及如何定義兩個 model<br>接下來，這邊將會簡單呈現，透過 orm 執行 database query，並將回傳結果的 orm model搬移到 pydantic model 的過程</p>
<blockquote>
<p>關於 ORM 的 DATABASE OPERATION 會在下個章節介紹，這邊的重點會著重在兩個 model的資料搬移</p>
</blockquote>
<p>以下是一個簡單的範例，建議可以建立一個測試腳本 e.g <code>test.pt</code> 來試試</p>
<blockquote>
<p>這邊預期開發者已建立好 database及對應的 table schema<br>如果開發者尚未建立 database 及 table schema，以下程式碼將會無法使用<br>建議開發者們可以自行手動建立 database and table schema 或是使用 database migration<br>如果不清楚 database migration，可以參考 <a target="_blank" rel="noopener" href="https://fastapi.tiangolo.com/tutorial/sql-databases/#migrations"><strong>Database migration</strong></a></p>
</blockquote>
<figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment"># assume create a test.py, and write in</span></span><br><span class="line"><span class="hljs-comment"># import database session, user orm model, user pydantic model</span></span><br><span class="line"><span class="hljs-keyword">from</span> .database <span class="hljs-keyword">import</span> get_db_session</span><br><span class="line"><span class="hljs-keyword">from</span> .schemas <span class="hljs-keyword">import</span> User <span class="hljs-keyword">as</span> UserSchema</span><br><span class="line"><span class="hljs-keyword">from</span> .models <span class="hljs-keyword">import</span> User</span><br><span class="line"><span class="hljs-comment"># import fastapi special encoder jsonable_encoder</span></span><br><span class="line"><span class="hljs-keyword">from</span> fastapi.encoders <span class="hljs-keyword">import</span> jsonable_encoder</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">orm_to_pydantic</span>(<span class="hljs-params">orm_model</span>):</span></span><br><span class="line">    <span class="hljs-string">"""將 ORM model 的資料搬移到 Pydantic model"""</span></span><br><span class="line">    <span class="hljs-comment"># 1. convert orm model to json format by jsonable_encoder</span></span><br><span class="line">    <span class="hljs-comment"># 2. unwrapped jsonable query_result into UserSchema(as user pydantic model)</span></span><br><span class="line">    jsonable_result = jsonable_encoder(orm_model)</span><br><span class="line">    <span class="hljs-keyword">return</span> UserSchema(**jsonable_result)</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">pydantic_to_orm</span>(<span class="hljs-params">pydantic_model</span>):</span></span><br><span class="line">    <span class="hljs-string">"""將 Pydantic model 的資料搬移到 ORM model"""</span></span><br><span class="line">    <span class="hljs-keyword">return</span> User(**pydantic_model.<span class="hljs-built_in">dict</span>())</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">query_user</span>():</span></span><br><span class="line">    <span class="hljs-comment"># get database session, it will return generator first</span></span><br><span class="line">    db = get_db_session()</span><br><span class="line">    <span class="hljs-comment"># execute database query, the result is a list of user orm model</span></span><br><span class="line">    users_orm_model = db.query(User).<span class="hljs-built_in">all</span>()</span><br><span class="line">    user_pydantic_model = [orm_to_pydantic(user_orm_model) <span class="hljs-keyword">for</span> user_orm_model <span class="hljs-keyword">in</span> users_orm_model]</span><br><span class="line">    print(user_pydantic_model)</span><br></pre></td></tr></tbody></table></figure>

<p>上面程式碼，有兩個關於 database operation的部分還沒提到，分別是 database session instance 建立以及 datbase CRUD operation，這兩個部分後面章節會介紹，暫時先不再這裡解釋</p>
<blockquote>
<p><code>jsonable_encoder</code> 是 FastAPI 提供的一個方便進行資料格式轉化工具，可以將資料轉換成 JSON data format<br>詳細可以參考至<a target="_blank" rel="noopener" href="https://fastapi.tiangolo.com/tutorial/encoder/">FastAPI - JSON Compatible Encoder</a></p>
</blockquote>
<h3 id="Pydantic-model-Config"><a href="#Pydantic-model-Config" class="headerlink" title="Pydantic model Config"></a>Pydantic model Config</h3><p>延續**如何進行 Pydantic model 和 ORM model 資料搬移?**章節，當執行範例程式碼會發現回傳出來的結果 pydanic model 的 attribute <code>books</code> 裡面的資料是空的，但如果直接看 database query 的結果反而可以看到關聯資料，為什麼會發生這類情況呢?</p>
<blockquote>
<p>主要原因在於 ORM 本身 lazy loading 特性的關係</p>
</blockquote>
<p>ORM lazy loading，會讓有建立關聯的 orm model，不能直接抽取關聯資料，除非直接去 access 該 orm model 代表關聯的 attribute e.g 以上述宣告的 <code>Users</code> model 為例，並且以 <code>my_user</code> 代表該 orm model 的 instance，如果要取得關聯的 book 資料，就必須要 access attribute <code>my_user.books</code> 這樣 database 才可以根據 foreign key 找到關聯資料並抽取出來</p>
<blockquote>
<p>關於這部分問題的解決方式，可以透過 Pydantic model Config 設定 <code>orm_mode</code> 來處理</p>
</blockquote>
<p><code>orm_mode</code> 可以讓 Pydantic model compatible with ORM model，讀取 ORM model資料，一方面進行資料搬移的時候不會出現找不到關聯資料的問題，另一方面因為 pydantic model 整合 FastAPI，可以直接將 Pydantic model 宣告在 path response，當對 db讀取資料，可以不用再手動進行 ORM to Pydantic model的資料搬移，直接在 path operation function 內回傳 orm model就行</p>
<p>宣告方式，只需要在該 pydantic model 內設定以下程式碼即可 </p>
<ul>
<li>For example<figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span>(<span class="hljs-params">BaseModel</span>):</span></span><br><span class="line">    <span class="hljs-built_in">id</span>: <span class="hljs-built_in">int</span> = Field(...)</span><br><span class="line">    name: <span class="hljs-built_in">str</span> = Field(...)</span><br><span class="line">    email: <span class="hljs-built_in">str</span> = Field(...)</span><br><span class="line">    active: <span class="hljs-built_in">bool</span> = Field(...)</span><br><span class="line">    books: List[Books]</span><br><span class="line">    <span class="hljs-comment"># 加在這裡</span></span><br><span class="line">    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Config</span>:</span></span><br><span class="line">            orm_mode = <span class="hljs-literal">True</span></span><br></pre></td></tr></tbody></table></figure></li>
</ul>
<p>Pydantic model 加入 <code>orm_mode</code> 之後，可以在回**如何進行 Pydantic model 和 ORM model 資料搬移?**章節，實際測試範例程式碼，並確認輸出結果，是不是有解決問題</p>
<p>設定好 <code>orm_mode</code>之後，還有哪些地方，可以感受到差異呢?</p>
<ul>
<li>在 path operation 宣告 response_model<br>  透過 <code>orm_mode</code>，可以直接在 path opearation 直接回傳目標資料的 orm model，fastapi 會再根據 <code>response_model</code> 進行資料驗證及資料轉化  <figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment"># assume get_db_session declare in database.py</span></span><br><span class="line"><span class="hljs-keyword">from</span> .database <span class="hljs-keyword">import</span> get_db_session</span><br><span class="line"><span class="hljs-keyword">from</span> .schemas <span class="hljs-keyword">import</span> UserSchema</span><br><span class="line"><span class="hljs-keyword">from</span> .models <span class="hljs-keyword">import</span> User</span><br><span class="line"><span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">'/user'</span>, response_model=List[UserSchema]</span>)</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_all_user</span>(<span class="hljs-params">db = get_db_session(<span class="hljs-params"></span>)</span>):</span></span><br><span class="line">    <span class="hljs-keyword">return</span> db.query(User).<span class="hljs-built_in">all</span>()</span><br></pre></td></tr></tbody></table></figure></li>
</ul>
<h2 id="建立資料庫-CRUD-方法"><a href="#建立資料庫-CRUD-方法" class="headerlink" title="建立資料庫 CRUD 方法"></a>建立資料庫 CRUD 方法</h2><p>在 FastAPI 內建立 crud 方法，建議根據不同 ORM model(也可以視為不同 table) 來建立各自獨立的 DB操作模組，可以提供給 path operation 使用之外，也方便進行 unit testing</p>
<p>以下程式碼將會實現基本 CRUD method，並描述在 <code>crud.py</code></p>
<figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment"># import database session 定義 function parameter 的型別</span></span><br><span class="line"><span class="hljs-keyword">from</span> sqlalchemy.orm <span class="hljs-keyword">import</span> Session</span><br><span class="line"><span class="hljs-keyword">from</span> .models <span class="hljs-keyword">import</span> User</span><br><span class="line"><span class="hljs-keyword">from</span> .schemas <span class="hljs-keyword">import</span> User <span class="hljs-keyword">as</span> UserSchema</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># 指定查詢符合 User.id 的 user table 資料</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_user</span>(<span class="hljs-params">db: Session, user_id: <span class="hljs-built_in">int</span></span>):</span></span><br><span class="line">    <span class="hljs-keyword">return</span> db.query(User).<span class="hljs-built_in">filter</span>(User.<span class="hljs-built_in">id</span> === user_id)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># 查詢所有 user 資料，並限制每次查詢數量</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_users</span>(<span class="hljs-params">db: Session, skip: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span>, limit: <span class="hljs-built_in">int</span> = <span class="hljs-number">100</span></span>):</span></span><br><span class="line">    <span class="hljs-keyword">return</span> db.query(models.User).offset(skip).limit(limit).<span class="hljs-built_in">all</span>()</span><br><span class="line">    </span><br><span class="line"><span class="hljs-comment"># 建立 user table 資料</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">craete</span>(<span class="hljs-params">db: Session, user_in: UserSchema</span>):</span></span><br><span class="line">    <span class="hljs-comment"># 轉化 pydantic model to orm model</span></span><br><span class="line">    created_user = User(**user_in.<span class="hljs-built_in">dict</span>())</span><br><span class="line">    <span class="hljs-comment"># add instance object into database session</span></span><br><span class="line">    <span class="hljs-comment"># 增加 user orm model 所建立的 instance 到 database session</span></span><br><span class="line">    db.add(created_user)</span><br><span class="line">    <span class="hljs-comment"># 提交 transaction to database (該 instance 會確實保存在 database)</span></span><br><span class="line">    db.commit()</span><br><span class="line">    <span class="hljs-comment"># refresh instance (從 database 抽取該 instance 資料)</span></span><br><span class="line">    db.refresh(created_user)</span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<p>可以參考各大網站提供的 SQLAlchemy crud method，這邊就不特別引用參考了<br>關於 Database session 進行基礎 CRUD操作的細節介紹，也可以參考 <a target="_blank" rel="noopener" href="https://docs.sqlalchemy.org/en/13/orm/session_basics.html#basics-of-using-a-session">SQLAlchemy - Basics of Using a Session</a></p>
</blockquote>
<h3 id="實際使用-database-operation"><a href="#實際使用-database-operation" class="headerlink" title="實際使用 database operation"></a>實際使用 database operation</h3><p>到目前為止，已經宣告好 database crud 操作了，接著該如何實際使用?</p>
<p>FastAPI 透過 SQLAlchemy ORM 操作 database，實際上是透過 database session，還記得在 initial create SQLAlchemy 這個章節，有 create database session，接下來如果需要進行任何有關 database 操作，首先需要先建立 database session instance，如下</p>
<blockquote>
<p>關於 Session 這部分操作的細節介紹，也可以參考 <a target="_blank" rel="noopener" href="https://docs.sqlalchemy.org/en/13/orm/session_basics.html#when-do-i-construct-a-session-when-do-i-commit-it-and-when-do-i-close-it">SQLAlchemy - When do I construct a Session, when do I commit it, and when do I close it?</a></p>
</blockquote>
<blockquote>
<p>這邊預期開發者已建立好 database及對應的 table schema<br>如果開發者尚未建立 database 及 table schema，以下程式碼將會無法使用<br>建議開發者們可以自行手動建立 database and table schema 或是使用 database migration<br>如果不清楚 database migration，可以參考 <a target="_blank" rel="noopener" href="https://fastapi.tiangolo.com/tutorial/sql-databases/#migrations"><strong>Database migration</strong></a></p>
</blockquote>
<p>以下為範例程式碼，建議可以建立一個測試腳本 <code>test.py</code> 來實際運作試試</p>
<figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">from</span> .database <span class="hljs-keyword">import</span> get_db_session</span><br><span class="line"><span class="hljs-keyword">from</span> .crud <span class="hljs-keyword">import</span> get_user</span><br><span class="line"><span class="hljs-keyword">from</span> .schema <span class="hljs-keyword">import</span> User <span class="hljs-keyword">as</span> UserSchema</span><br><span class="line"><span class="hljs-comment"># import fastapi 提供的 json 資料格式轉化工具，協助 transfer data from orm model to pydantic model</span></span><br><span class="line"><span class="hljs-keyword">from</span> fastapi.encoders <span class="hljs-keyword">import</span> jsonable_encoder</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:</span><br><span class="line">    <span class="hljs-comment"># 取得 database session instance，這邊，</span></span><br><span class="line">    db_session = <span class="hljs-built_in">next</span>(get_db_session())</span><br><span class="line">    <span class="hljs-comment"># 執行 database query，並回傳 User model</span></span><br><span class="line">    user = get_user(db_session, user_id=<span class="hljs-number">1</span>)</span><br><span class="line">    <span class="hljs-comment"># 針對 orm model 指定欄位資料的方式，需要像 class.attribute 這樣，以 class 指定 attribute 的方式來 access value</span></span><br><span class="line">    print(user.<span class="hljs-built_in">id</span>)</span><br><span class="line">    <span class="hljs-comment"># 將 user orm model 的資料搬移給 user 的 pydantic model，進行資料驗證和轉化</span></span><br><span class="line">    user = UserSchema(**jsonable_encoder(user))</span><br><span class="line">    <span class="hljs-comment"># pydantic model 可以直接轉化成 dict</span></span><br><span class="line">    print(user.<span class="hljs-built_in">dict</span>())</span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<p><code>next()</code> 可以取得 iterable object中的下一個 object，generator 也是屬於 iterable object</p>
</blockquote>
<h3 id="在-path-operation-使用-database-operation"><a href="#在-path-operation-使用-database-operation" class="headerlink" title="在 path operation 使用 database operation"></a>在 path operation 使用 database operation</h3><p>經過上一個章節<strong>實際使用 database operation</strong> 的介紹，已經知道如何單獨使用 database crud method</p>
<p>接下來這一個章節，將會介紹該如何在 FastAPI path operation 中進行 database crud operation</p>
<p>在<strong>檔案結構</strong>章節有提到<code>main.py</code> 這個 fastapi 執行檔，以下程式碼將會描述在該檔案</p>
<figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">from</span> .database <span class="hljs-keyword">import</span> get_db_session</span><br><span class="line"><span class="hljs-keyword">from</span> .crud <span class="hljs-keyword">import</span> get_user</span><br><span class="line"><span class="hljs-keyword">from</span> .schema <span class="hljs-keyword">import</span> User <span class="hljs-keyword">as</span> UserSchema</span><br><span class="line"><span class="hljs-comment"># import fastapi 提供的 json 資料格式轉化工具，協助 transfer data from orm model to pydantic model</span></span><br><span class="line"><span class="hljs-keyword">from</span> fastapi.encoders <span class="hljs-keyword">import</span> jsonable_encoder</span><br><span class="line"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> Depend, FastAPI, HTTPException</span><br><span class="line">app = FastAPI()</span><br><span class="line"><span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">'/user/{user_id}'</span>, response_model=UserSchema</span>)</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_user</span>(<span class="hljs-params">user_id: <span class="hljs-built_in">int</span>, db_session: Session = Depends(<span class="hljs-params">get_db_session</span>)</span>):</span></span><br><span class="line">    <span class="hljs-comment"># 執行 database query，並回傳 User model</span></span><br><span class="line">    user = get_user(db_session, user_id=user_id)</span><br><span class="line">    <span class="hljs-comment"># 針對 orm model 指定欄位資料的方式，需要像 class.attribute 這樣，以 class 指定 attribute 的方式來 access value</span></span><br><span class="line">    print(user.<span class="hljs-built_in">id</span>)</span><br><span class="line">    <span class="hljs-comment"># 將 user orm model 的資料搬移給 user 的 pydantic model，進行資料驗證和轉化</span></span><br><span class="line">    user = UserSchema(**jsonable_encoder(user))</span><br><span class="line">    <span class="hljs-comment"># pydantic model 可以直接轉化成 dict</span></span><br><span class="line">    print(user.<span class="hljs-built_in">dict</span>())</span><br><span class="line">    <span class="hljs-keyword">return</span></span><br></pre></td></tr></tbody></table></figure>

<p>解釋<code>Depends(get_db_session)</code></p>
<p>已知如果要進行 database operation，需要透過 <code>get_db_session()</code> 取得 database session instance</p>
<p>不過針對 API 每一次 request，都需要建立一個新的 session 來處理 request，該怎麼做呢?</p>
<ol>
<li>每個 path operation 都宣告 <code>db = next(get_db_session())</code> 來取得 session instance</li>
<li>透過 FastAPI 支援的 Dependency 功能，在 request 近來 fucntion 之前，先取得 session instance 之後，在 inject 到 path operation function，並在 API respond 之後，關閉 session 連線</li>
</ol>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>以上內容均參考至</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://fastapi.tiangolo.com/tutorial/sql-databases/">FastAPI - SQL (Relational) Databases</a></li>
<li><a target="_blank" rel="noopener" href="https://fastapi.tiangolo.com/tutorial/encoder/">FastAPI - JSON Compatible Encoder</a></li>
<li><a target="_blank" rel="noopener" href="https://fastapi.tiangolo.com/tutorial/sql-databases/#migrations">FastAPI- Database migration</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.sqlalchemy.org/en/13/orm/tutorial.html">SQLAlchemy</a><h2 id="進階用法"><a href="#進階用法" class="headerlink" title="進階用法"></a>進階用法</h2></li>
</ul>
</body></html>
    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/FastAPI-Python-Framework/">#FastAPI, Python, Framework</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop is-hidden-mobile article-nav-prev">
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2021/01/16/fastapi-ch4/">【快速上車 FastAPI，感受開發快感】 - 定義 Response 和 Exception</a>
            
        </span>
    </div>
    
</article>


<div class="sharebox">
    
<div class="notification is-danger">
    You need to set <code>install_url</code> to use ShareThis. Please set it in <code>_config.yml</code>.
</div>

</div>



<div class="comments">
    <h3 class="title is-4">Comments</h3>
    
<div id="disqus_thread">
    
    <div class="notification is-danger">
        You forgot to set the <code>shortname</code> for Disqus. Please set it in <code>_config.yml</code>.
    </div>
    
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2021 theoohoho&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow has-text-black" title="GitHub" target="_blank" rel="noopener" href="https://github.com/theoohoho">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>

<!-- test if the browser is outdated -->
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js"></script>
<script>
    $(document).ready(function () {
        // plugin function, place inside DOM ready function
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        })
    });
</script>

<script>
    window.FontAwesomeConfig = {
        searchPseudoElements: true
    }
    moment.locale("en-AU");
</script>


    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script>
    MathJax.Hub.Config({
        "HTML-CSS": {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
</script>

    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/js/jquery.justifiedGallery.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof($.fn.justifiedGallery) === 'function') {
                $('.justified-gallery').justifiedGallery();
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js"></script>


    
    <div class="searchbox ins-search">
    <div class="searchbox-mask"></div>
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="Type something..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>

<script src="/js/insight.js"></script>

    
</body>
</html>